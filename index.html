<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANUSHRI_ARCHIVE.vhs</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Cormorant+Garamond:ital,wght@0,600;1,600&display=swap');

        :root {
            --plastic: #111;
            --plastic-lit: #222;
            --crt-bg: #050505;
            --phosphor: #4af626; /* Classic Green */
            --phosphor-dim: #1e5c12;
            --phosphor-bright: #afffa1;
            --alert: #ff3333;
            --gold: #ffb84d;
            --tape-plastic: #1a1a1a;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-drag: none; }
        
        body {
            background: #080808;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'VT323', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--phosphor);
            perspective: 1200px;
        }

        /* --- THE VCR STATION (LAYOUT) --- */
        #station {
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: 1fr 140px;
            gap: 20px;
            width: 95vw;
            max-width: 1200px;
            height: 85vh;
            max-height: 800px;
        }

        /* --- THE TV SET --- */
        .tv-unit {
            grid-column: 1;
            grid-row: 1 / span 2;
            background: var(--plastic);
            border-radius: 20px;
            border: 4px solid #333;
            box-shadow: 
                inset 0 0 40px #000,
                0 0 50px rgba(0,0,0,0.8);
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 30px;
            transform-style: preserve-3d;
        }

        .screen-bezel {
            flex: 1;
            background: #000;
            border-radius: 60% 60% 4% 4% / 4% 4% 4% 4%; /* Subtle curve */
            position: relative;
            overflow: hidden;
            border: 2px solid #222;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
        }

        canvas#crt {
            display: block;
            width: 100%;
            height: 100%;
            opacity: 0.9;
            filter: contrast(1.2) brightness(1.1);
        }

        /* --- POST PROCESSING OVERLAYS --- */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
                        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 4px, 6px 100%;
            opacity: 0.6;
        }

        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 11;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.8) 100%);
        }

        .glass-glare {
            position: absolute; inset: 0; pointer-events: none; z-index: 12;
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 40%);
        }

        /* --- TAPE RACK (RIGHT SIDE) --- */
        .tape-rack {
            grid-column: 2;
            grid-row: 1;
            background: #151515;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            box-shadow: inset 0 0 20px #000;
        }

        .rack-label {
            color: #555;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        /* --- THE TAPE OBJECT --- */
        .vhs-tape {
            height: 110px;
            background: var(--tape-plastic);
            border-radius: 4px;
            border: 1px solid #333;
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.5);
        }
        
        .vhs-tape:active { cursor: grabbing; transform: scale(0.98); }
        .vhs-tape[draggable="false"] { opacity: 0.5; cursor: default; filter: grayscale(1); }

        /* Tape Windows */
        .vhs-tape::before {
            content: ''; position: absolute; top: 15px; left: 10%; width: 80%; height: 35px;
            background: #222; border-radius: 2px;
            background-image: 
                radial-gradient(circle at 20% 50%, #fff 10%, transparent 11%),
                radial-gradient(circle at 80% 50%, #fff 10%, transparent 11%);
            background-size: 40px 100%;
        }

        .tape-label-sticker {
            background: #eee;
            color: #000;
            padding: 4px 10px;
            margin-top: 45px;
            width: 85%;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-1deg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border-radius: 2px;
        }

        /* --- THE PLAYER (SLOT) --- */
        .vcr-player {
            grid-column: 2;
            grid-row: 2;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.5);
        }

        .slot-mouth {
            width: 80%;
            height: 30px;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .slot-mouth.drag-over {
            border-color: var(--phosphor);
            box-shadow: 0 0 15px var(--phosphor);
        }

        .slot-flap {
            width: 100%; height: 100%; background: #222;
            transform-origin: top; transition: transform 0.3s;
        }
        
        .slot-mouth.inserting .slot-flap { transform: rotateX(-90deg); }

        .led-panel {
            display: flex; gap: 15px; font-size: 12px; color: #555; text-transform: uppercase;
        }
        .led { width: 8px; height: 8px; background: #300; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .led.on { background: #f00; box-shadow: 0 0 5px #f00; }
        .led.play { background: #030; }
        .led.play.active { background: #0f0; box-shadow: 0 0 5px #0f0; }

        .eject-btn {
            position: absolute; right: 10px; bottom: 10px;
            padding: 5px 10px; background: #333; border: 1px solid #555; color: #ccc;
            cursor: pointer; font-family: inherit; font-size: 12px;
        }
        .eject-btn:hover { background: #444; color: #fff; }

        /* --- UI OVERLAYS (INSIDE CANVAS) --- */
        #game-ui {
            position: absolute; top: 30px; left: 30px; right: 30px; bottom: 30px;
            pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .channel-id {
            color: var(--phosphor-dim); font-size: 2rem; opacity: 0.5;
            text-shadow: 0 0 2px var(--phosphor);
        }
        .subtitle-box {
            align-self: center; text-align: center;
            color: var(--phosphor-bright);
            font-size: 1.5rem;
            text-shadow: 0 0 8px var(--phosphor);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            opacity: 0; transition: opacity 0.5s;
        }
        
        /* --- MOBILE --- */
        @media (max-width: 900px) {
            #station { grid-template-columns: 1fr; grid-template-rows: 1fr 120px 200px; height: 100vh; }
            .tv-unit { grid-column: 1; grid-row: 1; }
            .vcr-player { grid-column: 1; grid-row: 2; }
            .tape-rack { grid-column: 1; grid-row: 3; flex-direction: row; overflow-x: auto; }
            .vhs-tape { min-width: 140px; height: 90px; }
        }
    </style>
</head>
<body>

<div id="station">
    
    <!-- TV UNIT -->
    <div class="tv-unit">
        <div class="screen-bezel" id="tv-screen">
            <canvas id="crt"></canvas>
            <div class="scanlines"></div>
            <div class="vignette"></div>
            <div class="glass-glare"></div>
            
            <div id="game-ui">
                <div class="channel-id" id="channel-disp">AV-1</div>
                <div class="subtitle-box" id="subs"></div>
            </div>
        </div>
    </div>

    <!-- TAPE RACK -->
    <div class="tape-rack">
        <div class="rack-label">ARCHIVE // ANUSHRI</div>
        
        <div class="vhs-tape" id="tape1" draggable="true" data-id="1">
            <div class="tape-label-sticker">TAPE 01: THE HALLWAY</div>
        </div>
        
        <div class="vhs-tape" id="tape2" draggable="true" data-id="2">
            <div class="tape-label-sticker" style="color:#a00">TAPE 02: THE CURVE</div>
        </div>
        
        <div class="vhs-tape" id="tape3" draggable="true" data-id="3">
            <div class="tape-label-sticker" style="font-style:italic">TAPE 03: SIGNAL LOST</div>
        </div>

        <div class="vhs-tape" id="tape4" draggable="false" data-id="4" style="display:none">
            <div class="tape-label-sticker" style="background:gold; color:black">TAPE 04: RECORD</div>
        </div>
    </div>

    <!-- VCR PLAYER -->
    <div class="vcr-player" id="vcr">
        <div class="led-panel">
            <div><span class="led on"></span> PWR</div>
            <div><span class="led play" id="led-play"></span> PLAY</div>
        </div>
        
        <div class="slot-mouth" id="slot">
            <div class="slot-flap"></div>
        </div>
        
        <div style="margin-top:10px; font-size:12px; color:#444">AUTO-TRACKING SYSTEM</div>
        <button class="eject-btn" onclick="Game.eject()">EJECT</button>
    </div>

</div>

<script>
/**
 * ANUSHRI ARCHIVE - AUDIO ENGINE (Procedural Web Audio API)
 * No external files. Pure synthesis.
 */
const AudioSys = {
    ctx: null,
    masterGain: null,
    
    init() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.3;
            this.masterGain.connect(this.ctx.destination);
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },

    playNoise(duration = 0.5, type = 'brown') {
        if (!this.ctx) return;
        const bufferSize = this.ctx.sampleRate * duration;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * (type==='white'?0.5:0.8);
        }
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        // Filter for "VHS Hum" (Brown noiseish)
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = type === 'brown' ? 400 : 2000;
        
        noise.connect(filter);
        filter.connect(this.masterGain);
        noise.start();
    },

    playTone(freq, type, duration, vol=0.1) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },

    playClunk() {
        this.init();
        this.playNoise(0.2, 'brown');
        this.playTone(100, 'square', 0.1, 0.4);
        setTimeout(() => this.playTone(60, 'sawtooth', 0.3, 0.4), 100);
    },

    // Procedural Music: Simple ambient loop
    musicInterval: null,
    startAmbience(mood) {
        if(this.musicInterval) clearInterval(this.musicInterval);
        
        if(mood === 'sad') {
            // Slow, melancholic sine waves
            this.musicInterval = setInterval(() => {
                const notes = [220, 261, 329, 392]; // Am7
                const note = notes[Math.floor(Math.random()*notes.length)];
                this.playTone(note, 'sine', 2.0, 0.05);
            }, 3000);
        } else if (mood === 'tense') {
            // Fast, low square waves
            this.musicInterval = setInterval(() => {
                this.playTone(110, 'sawtooth', 0.1, 0.05);
                setTimeout(() => this.playTone(115, 'sawtooth', 0.1, 0.05), 200);
            }, 500);
        } else if (mood === 'hope') {
            // Bright triangles
            this.musicInterval = setInterval(() => {
                const notes = [440, 554, 659, 880]; // A major
                const note = notes[Math.floor(Math.random()*notes.length)];
                this.playTone(note, 'triangle', 1.5, 0.05);
            }, 2000);
        }
    },
    
    stopMusic() {
        if(this.musicInterval) clearInterval(this.musicInterval);
    }
};

/**
 * TEXT ENGINE (Typewriter with nuance)
 */
const TextSys = {
    el: document.getElementById('subs'),
    queue: [],
    busy: false,
    
    show(text, duration = 2000) {
        this.queue.push({text, duration});
        if(!this.busy) this.process();
    },

    process() {
        if(this.queue.length === 0) {
            this.el.style.opacity = 0;
            this.busy = false;
            return;
        }

        this.busy = true;
        const item = this.queue.shift();
        this.el.innerText = item.text;
        this.el.style.opacity = 1;
        
        // Dynamic "Speaking" sound
        const beepType = item.text.includes("GUIDE") ? 'square' : 'sine';
        const pitch = item.text.includes("GUIDE") ? 150 : 400;
        AudioSys.playTone(pitch, beepType, 0.1, 0.05);

        setTimeout(() => {
            this.process();
        }, item.duration);
    },
    
    clear() {
        this.queue = [];
        this.el.style.opacity = 0;
        this.busy = false;
    }
};

/**
 * GAME ENGINE (Canvas & Logic)
 */
const Game = {
    canvas: document.getElementById('crt'),
    ctx: document.getElementById('crt').getContext('2d'),
    width: 0,
    height: 0,
    state: 'static', // static, play, eject
    activeTape: null,
    frame: 0,
    
    // Game State Variables
    anushri: { x: 50, y: 0, w: 20, h: 20, vy: 0, grounded: false, emotion: 'neutral' },
    camX: 0,
    levelData: [],
    score: 0,
    
    init() {
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.loop();
        
        // Static Noise Loop
        setInterval(() => {
            if(this.state === 'static') this.drawStatic();
        }, 50);
    },

    resize() {
        const rect = this.canvas.parentElement.getBoundingClientRect();
        this.width = this.canvas.width = rect.width;
        this.height = this.canvas.height = rect.height;
    },

    insertTape(id) {
        if(this.state === 'play') return;
        
        AudioSys.playClunk();
        document.getElementById('slot').classList.add('inserting');
        document.getElementById('led-play').classList.add('active');
        
        // Disable tape drag
        document.getElementById(`tape${id}`).style.display = 'none';

        setTimeout(() => {
            this.state = 'play';
            this.activeTape = parseInt(id);
            this.resetLevel();
            document.getElementById('channel-disp').innerText = `PLAY: TAPE 0${id}`;
            document.getElementById('slot').classList.remove('inserting');
        }, 1500);
    },

    eject() {
        if(!this.activeTape) return;
        AudioSys.playClunk();
        AudioSys.stopMusic();
        this.state = 'static';
        document.getElementById('led-play').classList.remove('active');
        document.getElementById('channel-disp').innerText = "AV-1";
        TextSys.clear();
        
        // Return tape
        const tape = document.getElementById(`tape${this.activeTape}`);
        tape.style.display = 'flex';
        tape.style.opacity = '1';
        this.activeTape = null;
        
        // Check win condition
        if(Levels.progress.tape3_done) {
            document.getElementById('tape4').style.display = 'flex';
        }
    },

    resetLevel() {
        this.frame = 0;
        this.anushri = { x: 50, y: this.height - 100, w: 20, h: 20, vy: 0, grounded: false };
        this.camX = 0;
        Levels.init(this.activeTape);
    },

    loop() {
        if(this.state === 'play') {
            this.update();
            this.draw();
        }
        requestAnimationFrame(() => this.loop());
    },

    update() {
        Levels.update(this.activeTape);
        this.frame++;
    },

    draw() {
        // Clear
        this.ctx.fillStyle = "#050505";
        this.ctx.fillRect(0, 0, this.width, this.height);
        
        Levels.draw(this.activeTape, this.ctx, this.width, this.height);
        
        // VHS Tracking Lines (Glitch)
        if(Math.random() > 0.98) {
            const y = Math.random() * this.height;
            this.ctx.fillStyle = "rgba(255,255,255,0.1)";
            this.ctx.fillRect(0, y, this.width, 10);
        }
    },

    drawStatic() {
        const w = this.width;
        const h = this.height;
        const idata = this.ctx.createImageData(w, h);
        const buffer32 = new Uint32Array(idata.data.buffer);
        const len = buffer32.length;
        
        for (let i = 0; i < len; i++) {
            if (Math.random() < 0.1) buffer32[i] = 0xff111111; // Dark noise
            else buffer32[i] = 0xff000000; // Black
        }
        this.ctx.putImageData(idata, 0, 0);
        
        // Render Text "NO SIGNAL"
        this.ctx.fillStyle = "#1e5c12";
        this.ctx.font = "30px 'VT323'";
        this.ctx.textAlign = "center";
        this.ctx.fillText("NO SIGNAL", w/2, h/2);
    }
};

/**
 * LEVELS & LOGIC
 */
const Levels = {
    progress: { tape1_done: false, tape2_hits: 0, tape3_done: false },
    guideCursor: { x: 0, y: 0, visible: true },
    
    // Tape 1: The Hallway (Walking Sim)
    t1: { peers: [], doorX: 800 },

    // Tape 2: The Curve (Bullet Hell)
    t2: { bullets: [], timer: 1000 },
    
    // Tape 3: Signal Lost (Interactive)
    t3: { noiseLevel: 1.0, clicks: 0 },

    init(id) {
        if(id === 1) {
            AudioSys.startAmbience('sad');
            this.t1.peers = Array(5).fill(0).map((_,i) => ({x: 200 + i*150, h: 60, speed: 2 + Math.random()}));
            this.t1.doorX = 800;
            TextSys.show("GUIDE: Move forward. Don't let them intimidate you.", 3000);
        }
        if(id === 2) {
            AudioSys.startAmbience('tense');
            this.t2.bullets = [];
            this.t2.timer = 1200; // 20 seconds approx
            Game.anushri.x = Game.width/2;
            TextSys.show("GUIDE: It's the Bell Curve. Just survive.", 3000);
        }
        if(id === 3) {
            AudioSys.stopMusic(); // Silence
            AudioSys.playNoise(1.0, 'white');
            this.t3.noiseLevel = 1.0;
            this.t3.clicks = 0;
            this.guideCursor.visible = false; // Daddy is gone
            TextSys.show("SIGNAL LOST. TRACKING ERROR.", 2000);
            TextSys.show("MANUAL INTERVENTION REQUIRED.", 2000);
        }
        if(id === 4) {
            AudioSys.startAmbience('hope');
            Game.anushri.x = Game.width/2;
            Game.anushri.y = Game.height/2;
            TextSys.show("PLAYING RECORDING...", 3000);
        }
    },

    update(id) {
        if(id === 1) this.updateTape1();
        if(id === 2) this.updateTape2();
        if(id === 3) this.updateTape3();
        if(id === 4) this.updateTape4();
    },

    // --- TAPE 1 LOGIC ---
    updateTape1() {
        // Player moves right automatically but slowly
        const speed = Mouse.x > Game.width/2 ? 1 : 0;
        Game.anushri.x += speed;
        
        // Door logic: If you move too fast (Mouse far right), door runs away
        if(Mouse.x > Game.width * 0.8) {
            this.t1.doorX += 3; // Running away
            if(Game.frame % 60 === 0) TextSys.show("ANUSHRI: They are so fast...", 1000);
        } else if (speed > 0) {
            // Walking slow catches the door
        }

        // Peers (Parallax)
        this.t1.peers.forEach(p => {
            p.x -= p.speed;
            if(p.x < -50) p.x = Game.width + 50;
        });

        // Win
        if(Game.anushri.x > this.t1.doorX - 50) {
            TextSys.show("GUIDE: You made it. Not by running, but by enduring.", 3000);
            this.progress.tape1_done = true;
            setTimeout(() => Game.eject(), 4000);
        }
    },

    drawTape1(ctx, w, h) {
        // Floor
        ctx.fillStyle = '#222';
        ctx.fillRect(0, h-50, w, 50);
        
        // Peers (Silhouettes)
        ctx.fillStyle = '#111';
        this.t1.peers.forEach(p => {
            ctx.fillRect(p.x, h-50-p.h, 30, p.h);
        });

        // Door
        ctx.fillStyle = '#fff';
        ctx.fillRect(this.t1.doorX, h-120, 60, 70);

        // Player (White Heart/Shape)
        this.drawPlayer(ctx, Game.anushri.x, h-70);
    },

    // --- TAPE 2 LOGIC ---
    updateTape2() {
        // Player movement (Mouse follow)
        Game.anushri.x += (Mouse.x - Game.anushri.x) * 0.1;
        
        // Spawn Grades (Bullets)
        if(Game.frame % 10 === 0) {
            this.t2.bullets.push({
                x: Math.random() * Game.width, 
                y: -20, 
                val: Math.random() > 0.8 ? "F" : Math.floor(Math.random()*90),
                speed: 3 + Math.random()*2
            });
        }

        // Update Bullets
        this.t2.bullets.forEach((b, i) => {
            b.y += b.speed;
            // Collision
            if(Math.abs(b.x - Game.anushri.x) < 20 && Math.abs(b.y - (Game.height-100)) < 20) {
                this.t2.bullets.splice(i, 1);
                this.progress.tape2_hits++;
                AudioSys.playTone(100, 'sawtooth', 0.1); // Hit sound
                // Shake screen
                ctx.save();
                ctx.translate(Math.random()*5, Math.random()*5);
                ctx.restore();
            }
        });

        this.t2.timer--;
        if(this.t2.timer <= 0) {
            TextSys.show(`GUIDE: ${this.progress.tape2_hits} hits. But you're still standing.`, 3000);
            setTimeout(() => Game.eject(), 4000);
        }
    },

    drawTape2(ctx, w, h) {
        // Matrix Background
        ctx.fillStyle = `rgba(20, 0, 0, 0.1)`;
        ctx.fillRect(0,0,w,h);
        
        // Bullets
        ctx.font = "20px 'VT323'";
        this.t2.bullets.forEach(b => {
            ctx.fillStyle = b.val === "F" ? "#f00" : "#555";
            ctx.fillText(b.val, b.x, b.y);
        });

        // Player
        this.drawPlayer(ctx, Game.anushri.x, h-100, '#f00');
        
        // Timer
        ctx.fillStyle = "#fff";
        ctx.fillText(`SURVIVE: ${Math.floor(this.t2.timer/60)}`, 50, 50);
    },

    // --- TAPE 3 LOGIC ---
    updateTape3() {
        // The Pivot: Click to clear static
        if(Mouse.clicked) {
            this.t3.clicks++;
            this.t3.noiseLevel -= 0.1;
            Mouse.clicked = false;
            AudioSys.playTone(200 + (this.t3.clicks*50), 'sine', 0.1);
            
            if(this.t3.noiseLevel <= 0) {
                this.progress.tape3_done = true;
                TextSys.show("ANUSHRI: I fixed it. I didn't need the Guide.", 3000);
                setTimeout(() => Game.eject(), 4000);
            }
        }
        
        // Noise creeps back
        if(this.t3.noiseLevel < 1.0 && Game.frame % 20 === 0) {
            this.t3.noiseLevel += 0.01;
        }
    },

    drawTape3(ctx, w, h) {
        // Draw image hidden behind static
        ctx.fillStyle = "#fff";
        ctx.font = "40px 'VT323'";
        ctx.textAlign = "center";
        ctx.fillText("I AM SUFFICIENT", w/2, h/2);

        // Static Overlay
        const idata = ctx.getImageData(0,0,w,h);
        const data = idata.data;
        for(let i=0; i<data.length; i+=4) {
            if(Math.random() < this.t3.noiseLevel) {
                data[i] = data[i+1] = data[i+2] = Math.random()*255;
            }
        }
        ctx.putImageData(idata, 0, 0);
        
        if(this.t3.noiseLevel > 0.5) {
            ctx.fillStyle = "red";
            ctx.font = "20px 'VT323'";
            ctx.fillText("CLICK SCREEN TO ADJUST TRACKING", w/2, h-50);
        }
    },

    // --- TAPE 4 LOGIC ---
    updateTape4() {
        if(Game.frame === 100) TextSys.show("DADDY: Happy Birthday, Anushri.", 3000);
        if(Game.frame === 300) TextSys.show("DADDY: You thought you were failing.", 3000);
        if(Game.frame === 500) TextSys.show("DADDY: But I was watching.", 3000);
        if(Game.frame === 700) TextSys.show("DADDY: And this is what I saw.", 3000);
        
        if(Game.frame === 900) {
            // The Punchline: Showing the player's own stats
            TextSys.show(`HITS TAKEN: ${this.progress.tape2_hits}. TIMES YOU QUIT: 0.`, 4000);
        }
        
        if(Game.frame === 1200) {
            TextSys.show("I will always be DADDY.", 5000);
        }
    },

    drawTape4(ctx, w, h) {
        // Warm/Golden Aesthetic
        const grad = ctx.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, "#332200");
        grad.addColorStop(1, "#664400");
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,w,h);
        
        // Floating Heart
        const scale = 1 + Math.sin(Game.frame * 0.05) * 0.1;
        ctx.save();
        ctx.translate(w/2, h/2);
        ctx.scale(scale, scale);
        
        ctx.beginPath();
        ctx.fillStyle = "#ffb84d";
        ctx.arc(0, 0, 40, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    },

    // Helper: Draw Protagonist
    drawPlayer(ctx, x, y, color='#fff') {
        ctx.save();
        ctx.translate(x, y);
        // Breathing animation
        const s = 1 + Math.sin(Game.frame * 0.1) * 0.05;
        ctx.scale(s, s);
        
        ctx.fillStyle = color;
        ctx.beginPath();
        // Simple geometric "Soul" shape
        ctx.moveTo(0, -10);
        ctx.lineTo(10, 0);
        ctx.lineTo(0, 15);
        ctx.lineTo(-10, 0);
        ctx.closePath();
        ctx.fill();
        
        // Glow
        ctx.shadowColor = color;
        ctx.shadowBlur = 10;
        ctx.stroke();
        ctx.shadowBlur = 0;
        ctx.restore();
    },

    draw(id, ctx, w, h) {
        if(id === 1) this.drawTape1(ctx, w, h);
        if(id === 2) this.drawTape2(ctx, w, h);
        if(id === 3) this.drawTape3(ctx, w, h);
        if(id === 4) this.drawTape4(ctx, w, h);
    }
};

/**
 * INPUT HANDLING
 */
const Mouse = { x: 0, y: 0, clicked: false };

window.addEventListener('mousemove', e => {
    const rect = document.getElementById('crt').getBoundingClientRect();
    Mouse.x = e.clientX - rect.left;
    Mouse.y = e.clientY - rect.top;
});

document.getElementById('crt').addEventListener('mousedown', () => {
    Mouse.clicked = true;
});

/**
 * DRAG AND DROP SYSTEM
 */
const tapes = document.querySelectorAll('.vhs-tape[draggable="true"]');
const slot = document.getElementById('slot');

tapes.forEach(tape => {
    tape.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', tape.dataset.id);
        tape.style.opacity = '0.5';
    });
    
    tape.addEventListener('dragend', () => {
        tape.style.opacity = '1';
    });
});

slot.addEventListener('dragover', (e) => {
    e.preventDefault();
    slot.classList.add('drag-over');
});

slot.addEventListener('dragleave', () => {
    slot.classList.remove('drag-over');
});

slot.addEventListener('drop', (e) => {
    e.preventDefault();
    slot.classList.remove('drag-over');
    const id = e.dataTransfer.getData('text/plain');
    if(id) Game.insertTape(id);
});

// START
AudioSys.init();
Game.init();

</script>
</body>
</html>
