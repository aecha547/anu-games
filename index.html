<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANUSHRI_ARCHIVE.vhs // SYSTEM_READY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Caveat:wght@600&family=Share+Tech+Mono&display=swap');

        :root {
            --bg-dark: #050505;
            --chassis: #1a1a1a;
            --chassis-highlight: #2a2a2a;
            --phosphor-main: #39ff14; /* Classic Terminal Green */
            --phosphor-dim: #1b5e12;
            --phosphor-bright: #afffa1;
            --alert: #ff3333;
            --amber: #ffb84d;
            --crt-curvature: 3px;
            --font-ui: 'Share Tech Mono', monospace;
            --font-crt: 'VT323', monospace;
            --font-hand: 'Caveat', cursive;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #020202;
            overflow: hidden;
            font-family: var(--font-ui);
            color: var(--phosphor-main);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‚ïê‚ïê‚ïê BOOT OVERLAY ‚ïê‚ïê‚ïê */
        #boot-layer {
            position: fixed; inset: 0; z-index: 9999;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: opacity 0.8s ease-out;
        }
        #boot-layer.off { opacity: 0; pointer-events: none; }
        
        .boot-glitch {
            font-size: clamp(3rem, 8vw, 6rem);
            font-family: var(--font-crt);
            position: relative;
            color: var(--phosphor-main);
            text-shadow: 2px 0 var(--alert), -2px 0 blue;
            animation: glitch-skew 1s infinite linear alternate-reverse;
        }
        .boot-glitch::before, .boot-glitch::after {
            content: attr(data-text); position: absolute; left: 0; top: 0; width: 100%;
            opacity: 0.8; background: #000;
        }
        .boot-glitch::before {
            color: #ff00c1; clip-path: polygon(0 0, 100% 0, 100% 33%, 0 33%);
            animation: glitch-anim 2s infinite linear alternate-reverse;
        }
        .boot-glitch::after {
            color: #00fff9; clip-path: polygon(0 67%, 100% 67%, 100% 100%, 0 100%);
            animation: glitch-anim 1.5s infinite linear alternate-reverse;
        }
        .boot-sub { margin-top: 2rem; opacity: 0.5; letter-spacing: 2px; animation: blink 1s infinite; }

        /* ‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê */
        #station {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            width: 95vw; max-width: 1400px;
            height: 85vh; max-height: 800px;
            perspective: 1000px;
            opacity: 0; transition: opacity 1s;
        }

        /* ‚ïê‚ïê‚ïê TV UNIT ‚ïê‚ïê‚ïê */
        .tv-casing {
            background: #111;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 
                inset 0 0 40px #000,
                0 0 0 2px #222,
                0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            position: relative;
        }
        
        .screen-bezel {
            flex: 1;
            background: #000;
            border-radius: 60px / 20px; /* Curvature */
            border: 1px solid #333;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        /* CRT Effects */
        .crt-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 100;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            border-radius: 60px / 20px;
        }
        .crt-scanline {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: rgba(255,255,255,0.1);
            opacity: 0.4;
            animation: scanline 6s linear infinite;
            pointer-events: none; z-index: 101;
        }
        
        /* Screen Content */
        #crt-canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }
        
        #screen-content {
            position: absolute; inset: 20px; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            font-family: var(--font-crt);
            color: var(--phosphor-main);
            text-shadow: 0 0 4px var(--phosphor-dim), 2px 0 rgba(255,0,0,0.3), -2px 0 rgba(0,0,255,0.3);
            font-size: 1.2rem;
            overflow: hidden;
        }

        /* Screen Elements */
        .channel { position: absolute; top: 20px; right: 30px; font-size: 2rem; opacity: 0.6; }
        .rec-dot { 
            position: absolute; top: 25px; left: 30px; 
            color: var(--alert); display: flex; align-items: center; gap: 8px;
            opacity: 0; transition: opacity 0.3s;
        }
        .rec-dot.active { opacity: 1; }
        .rec-dot span { width: 12px; height: 12px; border-radius: 50%; background: var(--alert); box-shadow: 0 0 8px var(--alert); animation: blink 1s steps(2) infinite; }

        /* Control Panel */
        .controls {
            height: 80px;
            background: #161616;
            border-top: 2px solid #000;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
        }
        
        .slot-container {
            width: 240px; height: 36px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-bottom: 1px solid #444;
            border-radius: 4px;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 4px 10px #000;
            transition: all 0.3s;
        }
        .slot-container.drag-over { border-color: var(--phosphor-main); box-shadow: 0 0 15px var(--phosphor-dim); }
        .slot-door {
            position: absolute; inset: 2px; background: #1a1a1a;
            transform-origin: top; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; letter-spacing: 2px; color: #555;
        }
        .slot-container.inserting .slot-door { transform: rotateX(-90deg); }
        
        .btn-group { display: flex; gap: 12px; }
        .led { width: 8px; height: 8px; border-radius: 50%; background: #300; transition: background 0.2s; box-shadow: inset 0 0 2px rgba(0,0,0,0.8); }
        .led.on { background: #f00; box-shadow: 0 0 8px #f00; }
        .led.play { background: #030; }
        .led.play.on { background: #0f0; box-shadow: 0 0 8px #0f0; }

        .btn-eject {
            background: linear-gradient(#2a2a2a, #1a1a1a);
            border: 1px solid #333; color: #aaa;
            padding: 6px 16px; font-family: var(--font-ui); font-size: 0.8rem;
            cursor: pointer; border-radius: 2px;
            box-shadow: 0 2px 0 #000;
        }
        .btn-eject:active { transform: translateY(2px); box-shadow: none; }

        /* ‚ïê‚ïê‚ïê TAPE RACK ‚ïê‚ïê‚ïê */
        .rack {
            background: linear-gradient(135deg, #111, #080808);
            border: 2px solid #222; border-radius: 12px;
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
        }
        .rack-title { text-align: center; color: #444; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 5px; font-size: 0.8rem; letter-spacing: 0.2rem; }

        /* VHS TAPE STYLE */
        .tape {
            height: 110px;
            background: #181818;
            border-radius: 4px;
            border: 1px solid #282828;
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tape:hover { transform: translateY(-2px); border-color: #444; z-index: 10; }
        .tape:active { cursor: grabbing; }
        .tape.inserted { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .tape.locked { opacity: 0.5; pointer-events: none; }
        .tape.locked::after { content: "üîí"; position: absolute; font-size: 1.5rem; opacity: 0.5; }
        
        .tape-window {
            width: 70%; height: 26px;
            background: #050505; border: 1px solid #222; border-radius: 2px;
            margin-bottom: 8px; position: relative;
            display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
        }
        .reel { width: 18px; height: 18px; border-radius: 50%; background: #eee; border: 4px solid #fff; opacity: 0.8; }
        .tape:hover .reel { animation: spin 2s linear infinite; }
        
        .tape-label {
            width: 85%; padding: 4px; background: #eee; color: #111;
            font-family: var(--font-hand); font-weight: 700; font-size: 1.1rem;
            text-align: center; transform: rotate(-1deg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .tape-label sub { display: block; font-family: sans-serif; font-size: 0.5rem; color: #666; margin-top: -2px; letter-spacing: 1px; }

        /* DRAGGING GHOST */
        .tape-ghost {
            position: fixed; pointer-events: none; z-index: 10000;
            width: 240px; height: 130px;
            opacity: 0.9;
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.8));
            transform: rotate(-5deg);
        }

        /* ‚ïê‚ïê‚ïê ANIMATIONS ‚ïê‚ïê‚ïê */
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
        @keyframes glitch-anim { 0% { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); } 100% { clip-path: polygon(0 92%, 100% 92%, 100% 100%, 0 100%); } }
        @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 100% { transform: skew(0deg); } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            #station { grid-template-columns: 1fr; grid-template-rows: auto 160px; height: auto; }
            .rack { flex-direction: row; overflow-x: auto; overflow-y: hidden; }
            .tape { min-width: 160px; }
        }
        
        /* CONTENT CLASSES */
        .console-text { text-align: left; width: 90%; line-height: 1.4; white-space: pre-wrap; }
        .hl { color: var(--phosphor-bright); text-shadow: 0 0 10px var(--phosphor-bright); }
        .err { color: var(--alert); }
        .cursor { display: inline-block; width: 0.6em; height: 1.2em; background: var(--phosphor-main); animation: blink 1s step-end infinite; vertical-align: bottom; }
        
        /* Final Scene */
        .final-msg { font-size: 1.4rem; font-family: var(--font-hand); color: #fff; text-shadow: 0 0 15px #fff; opacity: 0; transform: translateY(20px); transition: 1s; }
        .final-msg.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="boot-layer">
        <h1 class="boot-glitch" data-text="ANUSHRI">ANUSHRI</h1>
        <div class="boot-sub">[ TOUCH TO INITIALIZE SYSTEM ]</div>
    </div>

    <div id="station">
        <!-- TV UNIT -->
        <div class="tv-casing">
            <div class="screen-bezel">
                <canvas id="crt-canvas"></canvas>
                <div class="crt-overlay"></div>
                <div class="crt-scanline"></div>
                <div id="screen-content">
                    <div class="channel">AV-1</div>
                    <div class="rec-dot" id="rec-dot"><span></span> REC</div>
                    <div id="osd">NO SIGNAL</div>
                </div>
            </div>
            
            <div class="controls">
                <div class="power-group btn-group">
                    <div style="text-align:center">
                        <div class="led" id="led-pwr"></div>
                        <span style="font-size:9px;color:#444;display:block;margin-top:4px">PWR</span>
                    </div>
                    <div style="text-align:center">
                        <div class="led play" id="led-play"></div>
                        <span style="font-size:9px;color:#444;display:block;margin-top:4px">RUN</span>
                    </div>
                </div>

                <div class="slot-container" id="tape-slot">
                    <div class="slot-door">INSERT TAPE</div>
                </div>

                <button class="btn-eject" id="btn-eject">‚èè EJECT</button>
            </div>
        </div>

        <!-- TAPE RACK -->
        <div class="rack" id="tape-rack">
            <div class="rack-title">ARCHIVE STORAGE</div>
            <!-- Tapes generated by JS -->
        </div>
    </div>

<script>
/**
 * ANUSHRI ARCHIVE v2.0 - Core System
 * Simulating analog hardware in a digital environment.
 */

// ‚ïê‚ïê‚ïê AUDIO ENGINE (Web Audio API) ‚ïê‚ïê‚ïê
const AudioSys = (() => {
    let ctx, master;
    let isMuted = false;

    const init = () => {
        if (ctx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        ctx = new AudioContext();
        master = ctx.createGain();
        master.gain.value = 0.3;
        master.connect(ctx.destination);
    };

    // Generic Oscillator Note
    const playTone = (freq, type, dur, vol = 0.1) => {
        if (!ctx) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(vol, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
        osc.connect(gain);
        gain.connect(master);
        osc.start();
        osc.stop(ctx.currentTime + dur);
    };

    // Noise Generator (Static)
    const playNoise = (dur, vol = 0.05) => {
        if (!ctx) return;
        const bufferSize = ctx.sampleRate * dur;
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        
        const noise = ctx.createBufferSource();
        noise.buffer = buffer;
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(vol, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
        noise.connect(gain);
        gain.connect(master);
        noise.start();
    };

    // Complex Sounds
    const sounds = {
        boot: () => {
            playTone(110, 'square', 0.5, 0.2);
            setTimeout(() => playTone(220, 'sine', 0.8, 0.2), 100);
            playNoise(0.5, 0.2);
        },
        click: () => playTone(800, 'triangle', 0.05, 0.05),
        mechInsert: () => {
            playNoise(0.4, 0.3); // Slide
            setTimeout(() => playTone(60, 'sawtooth', 0.2, 0.4), 300); // Clunk
            setTimeout(() => playTone(150, 'square', 0.1, 0.2), 500); // Lock
        },
        motor: () => {
            // Constant hum loop
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = 40;
            osc.type = 'sawtooth';
            gain.gain.value = 0.05;
            osc.connect(gain);
            gain.connect(master);
            osc.start();
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 2); // Fade out after 2s for effect
            osc.stop(ctx.currentTime + 2.1);
        },
        eject: () => {
             playTone(400, 'sine', 0.3, 0.2);
             playNoise(0.5, 0.2);
        }
    };

    return { init, play: (name) => sounds[name] && sounds[name](), playTone, playNoise };
})();

// ‚ïê‚ïê‚ïê CRT VISUALS (Canvas) ‚ïê‚ïê‚ïê
const CRT = (() => {
    const canvas = document.getElementById('crt-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let mode = 'static'; // static, play, off
    let animationId;

    const resize = () => {
        const rect = canvas.parentElement.getBoundingClientRect();
        width = canvas.width = rect.width;
        height = canvas.height = rect.height;
    };
    window.addEventListener('resize', resize);

    const drawStatic = () => {
        const idata = ctx.createImageData(width, height);
        const data = idata.data;
        for (let i = 0; i < data.length; i += 4) {
            const c = Math.random() * 20; // Dark static
            data[i] = c; data[i+1] = c; data[i+2] = c; data[i+3] = 255;
        }
        ctx.putImageData(idata, 0, 0);
        
        // Random Horizontal Tear
        if (Math.random() > 0.95) {
            const y = Math.random() * height;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, y, width, Math.random() * 10);
        }
    };

    const loop = () => {
        if (mode === 'static') drawStatic();
        else if (mode === 'off') {
             ctx.fillStyle = '#000'; ctx.fillRect(0,0,width,height);
        }
        animationId = requestAnimationFrame(loop);
    };

    return {
        init: () => { resize(); loop(); },
        setMode: (m) => mode = m,
        flash: () => {
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,width,height);
            setTimeout(() => mode = 'static', 50);
        }
    };
})();

// ‚ïê‚ïê‚ïê TAPE LOGIC ‚ïê‚ïê‚ïê
const Tapes = [
    { id: 't1', label: 'Side A: The Weight', sub: 'July 2003', type: 'text', data: [
        "> LOG: 07-2003",
        "> SUBJECT: FIRST MEMORY",
        "",
        "The air was heavy that summer.",
        "I remember the smell of ozone and wet pavement.",
        "",
        "You were small.",
        "Smaller than I thought a person could be.",
        "",
        "I held you and promised:",
        "\"I will catch everything that falls.\"",
        "",
        "> DATA CORRUPTION DETECTED...",
        "> END OF TAPE."
    ]},
    { id: 't2', label: 'TRACKING: Distortion', sub: 'Visual Test', type: 'glitch', duration: 5000 },
    { id: 't3', label: 'PLAY: Static', sub: 'White Noise', type: 'noise', duration: 4000 },
    { id: 't4', label: 'FINAL: For You', sub: 'Do Not Delete', type: 'final', locked: true }
];

const State = {
    inserted: null,
    played: new Set(),
    unlockFinal: function() {
        if (this.played.has('t1') && this.played.has('t2') && this.played.has('t3')) {
            document.querySelector('[data-id="t4"]').classList.remove('locked');
            return true;
        }
        return false;
    }
};

// ‚ïê‚ïê‚ïê UI CONTROLLER ‚ïê‚ïê‚ïê
const UI = (() => {
    const screen = document.getElementById('screen-content');
    const osd = document.getElementById('osd');
    const slot = document.getElementById('tape-slot');
    const rack = document.getElementById('tape-rack');
    
    // Typewriter effect
    const type = async (lines, speed = 30) => {
        osd.innerHTML = '<div class="console-text"></div>';
        const container = osd.querySelector('.console-text');
        
        for (let line of lines) {
            const p = document.createElement('div');
            container.appendChild(p);
            let text = line;
            
            for (let i = 0; i < text.length; i++) {
                p.innerHTML += text[i];
                AudioSys.playTone(800 + Math.random()*200, 'square', 0.02, 0.05); // blip
                await new Promise(r => setTimeout(r, speed));
            }
            await new Promise(r => setTimeout(r, 150));
        }
        container.innerHTML += '<span class="cursor"></span>';
    };

    const renderRack = () => {
        rack.innerHTML = '<div class="rack-title">ARCHIVE STORAGE</div>';
        Tapes.forEach(t => {
            const el = document.createElement('div');
            el.className = `tape ${t.locked ? 'locked' : ''}`;
            el.dataset.id = t.id;
            el.innerHTML = `
                <div class="tape-window"><div class="reel"></div><div class="reel"></div></div>
                <div class="tape-label">${t.label}<sub>${t.sub}</sub></div>
            `;
            
            // Interaction
            if (!t.locked) {
                el.addEventListener('mousedown', (e) => startDrag(e, t, el));
                el.addEventListener('touchstart', (e) => startDrag(e, t, el), {passive: false});
            }
            rack.appendChild(el);
        });
    };

    return { type, renderRack };
})();

// ‚ïê‚ïê‚ïê DRAG & DROP SYSTEM ‚ïê‚ïê‚ïê
let dragItem = null;
let ghost = null;

function startDrag(e, tapeData, originalEl) {
    if (State.inserted) return; // Slot full
    
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    
    // Create Ghost
    ghost = originalEl.cloneNode(true);
    ghost.classList.add('tape-ghost');
    ghost.style.width = originalEl.offsetWidth + 'px';
    document.body.appendChild(ghost);
    
    dragItem = { 
        data: tapeData, 
        el: originalEl,
        offsetX: touch.clientX - originalEl.getBoundingClientRect().left,
        offsetY: touch.clientY - originalEl.getBoundingClientRect().top
    };
    
    originalEl.style.opacity = 0;
    moveDrag(e);
}

function moveDrag(e) {
    if (!dragItem) return;
    const touch = e.touches ? e.touches[0] : e;
    const x = touch.clientX - dragItem.offsetX;
    const y = touch.clientY - dragItem.offsetY;
    
    ghost.style.left = x + 'px';
    ghost.style.top = y + 'px';
    
    // Tilt effect based on movement could go here
    
    // Check slot intersection
    const slot = document.getElementById('tape-slot').getBoundingClientRect();
    const gRect = ghost.getBoundingClientRect();
    
    const overlap = !(gRect.right < slot.left || gRect.left > slot.right || gRect.bottom < slot.top || gRect.top > slot.bottom);
    
    const slotEl = document.getElementById('tape-slot');
    if (overlap) slotEl.classList.add('drag-over');
    else slotEl.classList.remove('drag-over');
}

function endDrag(e) {
    if (!dragItem) return;
    
    const slotEl = document.getElementById('tape-slot');
    const wasOver = slotEl.classList.contains('drag-over');
    
    if (wasOver) {
        insertTape(dragItem.data);
    } else {
        dragItem.el.style.opacity = 1;
    }
    
    ghost.remove();
    slotEl.classList.remove('drag-over');
    dragItem = null;
}

document.addEventListener('mousemove', moveDrag);
document.addEventListener('touchmove', moveDrag, {passive: false});
document.addEventListener('mouseup', endDrag);
document.addEventListener('touchend', endDrag);

// ‚ïê‚ïê‚ïê PLAYER LOGIC ‚ïê‚ïê‚ïê
async function insertTape(tape) {
    State.inserted = tape;
    
    // Hide from rack
    const tapeEl = document.querySelector(`.tape[data-id="${tape.id}"]`);
    if(tapeEl) tapeEl.classList.add('inserted');

    // Animation
    const slot = document.getElementById('tape-slot');
    slot.classList.add('inserting');
    document.querySelector('.slot-door').innerText = "LOADING...";
    
    AudioSys.play('mechInsert');
    await new Promise(r => setTimeout(r, 800));
    
    slot.classList.remove('inserting');
    document.querySelector('.slot-door').innerText = "LOADED: " + tape.id;
    document.getElementById('led-play').classList.add('on');
    document.getElementById('rec-dot').classList.add('active');
    
    playContent(tape);
}

async function playContent(tape) {
    const osd = document.getElementById('osd');
    osd.innerHTML = '';
    
    AudioSys.play('motor');
    CRT.flash();
    
    // Loading header
    osd.innerHTML = `<div style="margin-bottom:20px; border:1px solid var(--phosphor-main); padding:2px 10px;">PLAY > ${tape.label}</div>`;
    await new Promise(r => setTimeout(r, 1000));
    
    if (tape.type === 'text') {
        await UI.type(tape.data);
    } else if (tape.type === 'glitch') {
        osd.innerHTML += '<div class="boot-glitch" data-text="ERROR">ERROR</div>';
        AudioSys.playNoise(2, 0.5);
        await new Promise(r => setTimeout(r, 2000));
        osd.innerHTML = "TRACKING ADJUSTED.";
    } else if (tape.type === 'final') {
        playFinalSequence();
        return; // Special handling
    }
    
    // Tape Finish
    await new Promise(r => setTimeout(r, 2000));
    State.played.add(tape.id);
    State.unlockFinal();
    UI.renderRack(); // Re-render to show locked status change if any
}

function ejectTape() {
    if (!State.inserted) return;
    AudioSys.play('eject');
    
    document.getElementById('led-play').classList.remove('on');
    document.getElementById('rec-dot').classList.remove('active');
    document.querySelector('.slot-door').innerText = "INSERT TAPE";
    document.getElementById('osd').innerText = "NO SIGNAL";
    
    // Return to rack
    const tapeEl = document.querySelector(`.tape[data-id="${State.inserted.id}"]`);
    if(tapeEl) {
        tapeEl.classList.remove('inserted');
        tapeEl.style.opacity = 1;
    }
    
    State.inserted = null;
}

document.getElementById('btn-eject').addEventListener('click', ejectTape);

async function playFinalSequence() {
    const osd = document.getElementById('osd');
    osd.innerHTML = '';
    
    const melody = [261, 329, 392, 523];
    melody.forEach((f, i) => setTimeout(() => AudioSys.playTone(f, 'sine', 1, 0.2), i*500));
    
    const msgs = [
        "You fixed the signal.",
        "You faced the static.",
        "The bravest recording...",
        "Was made by YOU.",
        "Happy Birthday, Anushri."
    ];
    
    for (let m of msgs) {
        const div = document.createElement('div');
        div.className = 'final-msg';
        div.innerText = m;
        osd.appendChild(div);
        
        // Trigger reflow
        void div.offsetWidth;
        div.classList.add('show');
        
        await new Promise(r => setTimeout(r, 2500));
        div.style.opacity = 0; // fade out previous
    }
    
    const final = document.createElement('div');
    final.className = 'final-msg show';
    final.style.color = 'var(--amber)';
    final.innerHTML = "ALWAYS PROUD.<br>- DADDY";
    osd.appendChild(final);
}

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê
document.getElementById('boot-layer').addEventListener('click', () => {
    AudioSys.init();
    AudioSys.play('boot');
    
    document.getElementById('boot-layer').classList.add('off');
    document.getElementById('station').style.opacity = 1;
    
    CRT.init();
    document.getElementById('led-pwr').classList.add('on');
    
    UI.renderRack();
});
</script>
</body>
</html>
