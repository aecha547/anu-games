<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ANUSHRI: PLAY/REWIND</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Caveat:wght@400;600&family=Cormorant+Garamond:ital,wght@0,400;1,400&display=swap');
:root{
--bg:#030303;--plastic:#1a1a1a;--screen-bg:#050508;
--phosphor:#a8e6a3;--amber:#ffb000;--gold:#d4af37;
--red:#cc4444;--blue:#5588bb;--cyan:#00d4aa;
--dim:#555;--warm:#ffeedd;--white:#d4d4d4;
--font-crt:'VT323',monospace;--font-hand:'Caveat',cursive;
--font-serif:'Cormorant Garamond',serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);font-family:var(--font-crt);color:var(--white);user-select:none}

/* === LAYOUT === */
.wrapper{
width:100%;height:100%;display:flex;flex-direction:column;
align-items:center;justify-content:center;gap:20px;padding:10px;
}

/* === TV BODY === */
.tv-body{
position:relative;width:min(94vw,760px);
background:linear-gradient(145deg,#222 0%,#181818 50%,#111 100%);
border-radius:20px;border:2px solid #2a2a2a;
box-shadow:0 20px 80px rgba(0,0,0,0.7),inset 0 1px 0 rgba(255,255,255,0.04);
overflow:hidden;
}

/* === TV SCREEN === */
.tv-screen{
position:relative;margin:14px 14px 0;aspect-ratio:4/3;
background:var(--screen-bg);border-radius:10px;overflow:hidden;
box-shadow:inset 0 0 40px rgba(0,0,0,0.8),0 0 2px rgba(168,230,163,0.05);
}
/* Scanlines */
.tv-screen::before{
content:'';position:absolute;inset:0;z-index:50;pointer-events:none;
background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.12) 2px,rgba(0,0,0,0.12) 4px);
}
/* Curvature */
.tv-screen::after{
content:'';position:absolute;inset:0;z-index:51;pointer-events:none;
background:radial-gradient(ellipse at center,transparent 58%,rgba(0,0,0,0.55) 100%);
}
/* Static canvas */
#static-canvas{position:absolute;inset:0;z-index:5;opacity:0.07}
/* Screen content */
#screen{position:absolute;inset:0;z-index:20;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px;overflow:hidden}

/* === SCREEN GLOW === */
.screen-glow{
position:absolute;inset:-15px;z-index:-1;border-radius:20px;
background:radial-gradient(ellipse,rgba(168,230,163,0.03) 0%,transparent 70%);
pointer-events:none;transition:background 1s;
}

/* === TV CONTROLS === */
.tv-controls{
display:flex;align-items:center;justify-content:space-between;
padding:10px 18px;background:#111;border-top:1px solid #1a1a1a;
}
.power-section{display:flex;align-items:center;gap:6px}
.power-led{
width:7px;height:7px;border-radius:50%;background:#1a0000;
border:1px solid #333;transition:all 0.5s;
}
.power-led.on{background:var(--red);box-shadow:0 0 6px var(--red)}
.ctrl-label{font-size:10px;letter-spacing:0.25em;color:#444;text-transform:uppercase}
.brand-label{font-size:11px;letter-spacing:0.3em;color:#333;text-transform:uppercase}

/* Tape Slot */
.tape-slot{
width:180px;height:18px;background:#080808;
border:1px solid #222;border-radius:2px;
box-shadow:inset 0 2px 6px rgba(0,0,0,0.8);
display:flex;align-items:center;justify-content:center;
transition:all 0.3s;position:relative;
}
.slot-label{font-size:10px;letter-spacing:0.15em;color:#333;transition:color 0.3s}
.tape-slot.active{border-color:var(--phosphor);box-shadow:inset 0 2px 6px rgba(0,0,0,0.8),0 0 12px rgba(168,230,163,0.15)}
.tape-slot.active .slot-label{color:var(--phosphor)}

/* === TAPE SHELF === */
.tape-shelf{
display:flex;gap:16px;flex-wrap:wrap;justify-content:center;
padding:0 10px;
}

/* === VHS TAPE === */
.vhs-tape{
width:150px;height:94px;background:linear-gradient(165deg,#1a1a1a 0%,#111 60%,#0a0a0a 100%);
border:1.5px solid #2a2a2a;border-radius:5px;position:relative;cursor:grab;
transition:transform 0.3s cubic-bezier(.17,.67,.35,1.3),box-shadow 0.3s,border-color 0.3s;
box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.vhs-tape:hover{
transform:translateY(-6px);border-color:#444;
box-shadow:0 8px 24px rgba(0,0,0,0.6);
}
.vhs-tape:active{cursor:grabbing}
.vhs-tape.locked{opacity:0.3;cursor:not-allowed;pointer-events:none}
.vhs-tape.complete .tape-status{color:var(--phosphor)}

/* Tape window */
.tape-window{
position:absolute;top:7px;left:16px;right:16px;height:30px;
background:#060606;border-radius:3px;border:1px solid #1a1a1a;
display:flex;align-items:center;justify-content:space-around;padding:0 10px;
overflow:hidden;
}
/* Reels */
.reel{
width:18px;height:18px;border-radius:50%;
border:1.5px solid #3a3a3a;background:#0a0a0a;
position:relative;transition:border-color 0.3s;
}
.reel::before,.reel::after{
content:'';position:absolute;background:#3a3a3a;
}
.reel::before{width:1px;height:100%;left:50%;top:0;transform:translateX(-50%)}
.reel::after{width:100%;height:1px;top:50%;left:0;transform:translateY(-50%)}
.vhs-tape:hover .reel{border-color:#555;animation:spin 2s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Tape strip between reels */
.tape-strip{width:30px;height:1px;background:#333}

/* Label */
.tape-label-area{
position:absolute;bottom:8px;left:10px;right:10px;
background:linear-gradient(#f0e8d8,#e8dcc8);
border-radius:2px;padding:4px 8px;
box-shadow:0 1px 3px rgba(0,0,0,0.3);
}
.tape-title{
font-family:var(--font-hand);font-size:14px;font-weight:600;
color:#222;line-height:1;white-space:nowrap;overflow:hidden;
}
.tape-status{
font-family:var(--font-crt);font-size:9px;color:#888;
letter-spacing:0.1em;margin-top:1px;
}
.tape-color{
position:absolute;top:7px;right:8px;width:6px;height:6px;
border-radius:50%;
}

/* Ghost tape during drag */
.tape-ghost{
position:fixed;z-index:9999;pointer-events:none;
opacity:0.85;transform:rotate(-3deg) scale(1.05);
filter:drop-shadow(0 8px 24px rgba(0,0,0,0.7));
}

/* === SCREEN STATES === */

/* Boot */
.boot-content{
width:85%;text-align:left;color:var(--phosphor);
font-size:clamp(14px,2.2vw,18px);line-height:1.8;
text-shadow:0 0 6px rgba(168,230,163,0.15);
}
.boot-content .cursor{
display:inline-block;width:8px;height:1.1em;background:var(--phosphor);
vertical-align:text-bottom;margin-left:2px;animation:blink 1s step-end infinite;
}
@keyframes blink{50%{opacity:0}}

/* Select screen */
.select-display{text-align:center}
.select-display h2{
font-size:clamp(20px,3.5vw,28px);letter-spacing:0.15em;
color:var(--phosphor);text-shadow:0 0 10px rgba(168,230,163,0.2);
margin-bottom:8px;
}
.select-display .sub{font-size:14px;color:var(--dim);letter-spacing:0.1em}
.select-display .rec{
position:absolute;top:16px;right:20px;font-size:13px;color:var(--red);
display:flex;align-items:center;gap:6px;
}
.select-display .rec-dot{
width:8px;height:8px;border-radius:50%;background:var(--red);
animation:blink 1.5s infinite;
}
.select-display .date-stamp{
position:absolute;top:16px;left:20px;font-size:12px;color:var(--dim);
}
.select-display .insert-msg{
margin-top:24px;font-size:15px;color:var(--dim);
animation:pulse 2.5s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.9}}

/* Loading */
.loading-display{text-align:center}
.loading-display .load-title{font-size:16px;color:var(--phosphor);margin-bottom:12px;letter-spacing:0.15em}
.load-bar{width:260px;height:8px;border:1px solid var(--phosphor);border-radius:4px;overflow:hidden;margin:0 auto}
.load-fill{height:100%;background:var(--phosphor);width:0%;transition:width 0.08s linear;border-radius:4px;box-shadow:0 0 6px var(--phosphor)}

/* Final */
.final-display{text-align:center;max-width:500px}
.final-display p{
font-family:var(--font-serif);font-size:clamp(14px,2vw,17px);
line-height:2;color:var(--warm);opacity:0;transform:translateY(10px);
transition:all 0.8s ease;margin-bottom:4px;
}
.final-display p.show{opacity:1;transform:translateY(0)}
.final-display .gold{color:var(--gold);font-weight:600;text-shadow:0 0 10px rgba(212,175,55,0.3)}
.final-display .hl{color:var(--phosphor)}

/* === AUDIO TOGGLE === */
.audio-btn{
position:fixed;top:10px;right:10px;z-index:200;
background:rgba(0,0,0,0.7);border:1px solid #333;border-radius:3px;
color:#555;font-family:var(--font-crt);font-size:12px;
padding:4px 10px;cursor:pointer;transition:all 0.2s;
}
.audio-btn:hover,.audio-btn.on{color:var(--phosphor);border-color:var(--phosphor)}

/* === RESPONSIVE === */
@media(max-width:640px){
.wrapper{gap:14px;padding:6px}
.tv-body{border-radius:14px}
.tv-screen{margin:10px 10px 0}
.tv-controls{padding:8px 12px}
.tape-slot{width:140px;height:15px}
.tape-shelf{gap:10px}
.vhs-tape{width:130px;height:82px}
.tape-window{top:5px;left:12px;right:12px;height:26px}
.reel{width:14px;height:14px}
.tape-label-area{bottom:6px;left:8px;right:8px;padding:3px 6px}
.tape-title{font-size:12px}
}
</style>
</head>
<body>

<button class="audio-btn" id="audio-btn">♪ OFF</button>

<div class="wrapper">
<div class="tv-body">
<div class="screen-glow" id="screen-glow"></div>
<div class="tv-screen" id="tv-screen">
<canvas id="static-canvas"></canvas>
<div id="screen"></div>
</div>
<div class="tv-controls">
<div class="power-section">
<div class="power-led" id="led"></div>
<span class="ctrl-label">PWR</span>
</div>
<div class="tape-slot" id="tape-slot">
<span class="slot-label" id="slot-label">▶ INSERT</span>
</div>
<span class="brand-label">ANUSHRI</span>
</div>
</div>
<div class="tape-shelf" id="tape-shelf"></div>
</div>

<script>
'use strict';

/* ═══════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════ */
const $=id=>document.getElementById(id);
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));

/* ═══════════════════════════════════════
   STATE (localStorage)
   ═══════════════════════════════════════ */
const State={
  KEY:'anushri_archive_v2',
  get(){try{return JSON.parse(localStorage.getItem(this.KEY))||{}}catch{return{}}},
  set(k,v){const s=this.get();s[k]=v;try{localStorage.setItem(this.KEY,JSON.stringify(s))}catch{}},
  isDone(t){return!!this.get()[t]},
  allDone(){return['tape1','tape2','tape3'].every(t=>this.isDone(t))},
};

/* ═══════════════════════════════════════
   STATIC NOISE
   ═══════════════════════════════════════ */
const Noise=(()=>{
  const c=$('static-canvas');const ctx=c.getContext('2d');
  let w=0,h=0;
  const resize=()=>{const r=c.parentElement.getBoundingClientRect();w=c.width=Math.ceil(r.width/2);h=c.height=Math.ceil(r.height/2);c.style.width='100%';c.style.height='100%';c.style.imageRendering='pixelated'};
  const draw=()=>{if(!w)return;const img=ctx.createImageData(w,h);const d=img.data;for(let i=0;i<d.length;i+=4){const v=Math.random()*255;d[i]=d[i+1]=d[i+2]=v;d[i+3]=Math.random()*30}ctx.putImageData(img,0,0);requestAnimationFrame(draw)};
  window.addEventListener('resize',resize);
  return{init(){resize();draw()},burst(dur=400){c.style.opacity='0.35';setTimeout(()=>c.style.opacity='0.07',dur)}};
})();

/* ═══════════════════════════════════════
   PROCEDURAL AUDIO (Synth Engine)
   ═══════════════════════════════════════ */
const Synth=(()=>{
  let ctx=null,master=null,muted=true;
  let drones=[],arpId=null;

  const init=()=>{
    if(ctx)return;
    ctx=new(window.AudioContext||window.webkitAudioContext)();
    master=ctx.createGain();master.gain.value=0;master.connect(ctx.destination);
  };
  const resume=()=>{if(ctx&&ctx.state==='suspended')ctx.resume()};
  const setMuted=(m)=>{
    muted=m;
    if(!ctx)return;
    master.gain.cancelScheduledValues(ctx.currentTime);
    master.gain.setValueAtTime(master.gain.value,ctx.currentTime);
    master.gain.linearRampToValueAtTime(m?0:0.45,ctx.currentTime+0.3);
  };

  const note=(freq,dur,type='triangle',vol=0.1,attack=0.01)=>{
    if(!ctx)return;
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=type;o.frequency.value=freq;
    g.gain.setValueAtTime(0.001,ctx.currentTime);
    g.gain.linearRampToValueAtTime(vol,ctx.currentTime+attack);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
    o.connect(g);g.connect(master);o.start();o.stop(ctx.currentTime+dur+0.05);
  };

  const noiseBurst=(dur=0.15,vol=0.08)=>{
    if(!ctx)return;
    const sz=Math.floor(ctx.sampleRate*dur);
    const buf=ctx.createBuffer(1,sz,ctx.sampleRate);
    const d=buf.getChannelData(0);
    for(let i=0;i<sz;i++)d[i]=(Math.random()*2-1);
    const s=ctx.createBufferSource();s.buffer=buf;
    const g=ctx.createGain();g.gain.setValueAtTime(vol,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
    s.connect(g);g.connect(master);s.start();
  };

  // SFX
  const mechClunk=()=>{note(80,0.2,'square',0.15);noiseBurst(0.06,0.12);setTimeout(()=>note(55,0.15,'square',0.1),40)};
  const typeClick=()=>note(1800+Math.random()*600,0.012,'square',0.025);
  const selectClick=()=>note(440,0.04,'square',0.04);
  const confirmSound=()=>{note(440,0.06,'square',0.04);setTimeout(()=>note(660,0.08,'square',0.04),50)};

  // Ambient
  const startAmbient=()=>{
    if(!ctx)return;
    // 60Hz hum
    const h=ctx.createOscillator(),hg=ctx.createGain();
    h.type='sine';h.frequency.value=60;hg.gain.value=0.012;
    h.connect(hg);hg.connect(master);h.start();
    drones.push({o:h,g:hg});
    // Pad drone A2
    const p=ctx.createOscillator(),pf=ctx.createBiquadFilter(),pg=ctx.createGain();
    p.type='sawtooth';p.frequency.value=110;pf.type='lowpass';pf.frequency.value=280;pg.gain.value=0.018;
    p.connect(pf);pf.connect(pg);pg.connect(master);p.start();
    drones.push({o:p,g:pg});
    // Tape hiss
    const sz=ctx.sampleRate*2;const buf=ctx.createBuffer(1,sz,ctx.sampleRate);
    const d=buf.getChannelData(0);for(let i=0;i<sz;i++)d[i]=Math.random()*2-1;
    const ns=ctx.createBufferSource();ns.buffer=buf;ns.loop=true;
    const nf=ctx.createBiquadFilter();nf.type='highpass';nf.frequency.value=4000;
    const ng=ctx.createGain();ng.gain.value=0.006;
    ns.connect(nf);nf.connect(ng);ng.connect(master);ns.start();
  };

  // Arpeggio
  const startArp=()=>{
    const notes=[220,261.63,329.63,440,329.63,261.63];
    let i=0;
    arpId=setInterval(()=>{
      note(notes[i%notes.length],1.2,'triangle',0.03,0.02);
      i++;
    },850);
  };
  const stopArp=()=>{if(arpId){clearInterval(arpId);arpId=null}};

  return{init,resume,setMuted,note,noiseBurst,mechClunk,typeClick,selectClick,confirmSound,startAmbient,startArp,stopArp};
})();

/* ═══════════════════════════════════════
   AUDIO TOGGLE
   ═══════════════════════════════════════ */
const audioBtn=$('audio-btn');
let audioOn=false;
audioBtn.addEventListener('click',()=>{
  Synth.init();Synth.resume();
  audioOn=!audioOn;
  Synth.setMuted(!audioOn);
  audioBtn.textContent=audioOn?'♪ ON':'♪ OFF';
  audioBtn.classList.toggle('on',audioOn);
});

/* ═══════════════════════════════════════
   TYPEWRITER
   ═══════════════════════════════════════ */
let typeAbort=false;
const typewrite=async(el,text,speed=30)=>{
  typeAbort=false;
  el.innerHTML='';
  for(let i=0;i<text.length;i++){
    if(typeAbort){el.innerHTML=text;return}
    if(text[i]==='<'){const j=text.indexOf('>',i);el.innerHTML+=text.substring(i,j+1);i=j}
    else{el.innerHTML+=text[i];Synth.typeClick()}
    await sleep(speed);
  }
};

/* ═══════════════════════════════════════
   SCREEN MANAGER
   ═══════════════════════════════════════ */
const Screen=(()=>{
  const el=$('screen');
  const clear=()=>{el.innerHTML=''};

  // BOOT
  const boot=async()=>{
    $('led').classList.add('on');
    clear();
    const div=document.createElement('div');div.className='boot-content';el.appendChild(div);
    const lines=[
      '> ANUSHRI TAPE ARCHIVE v1.0',
      '> INITIALIZING MEMORY SUBSYSTEM...',
      '> 4 RECORDINGS FOUND',
      '> WARNING: SOME TAPES CONTAIN DISTORTION',
      '> THIS IS EXPECTED.',
      '',
      '> [CLICK ANYWHERE TO CONTINUE]'
    ];
    for(const line of lines){
      await typewrite(div,div.textContent+line+'\n',20);
      await sleep(200);
    }
    div.innerHTML+=`<span class="cursor"></span>`;
    return new Promise(r=>{
      const h=()=>{typeAbort=true;document.removeEventListener('click',h);document.removeEventListener('keydown',h);r()};
      document.addEventListener('click',h);document.addEventListener('keydown',h);
    });
  };

  // SELECT
  const select=()=>{
    clear();
    const d=document.createElement('div');d.className='select-display';
    const now=new Date();
    const dateStr=now.toLocaleDateString('en-US',{month:'short',day:'2-digit',year:'numeric'}).toUpperCase();
    d.innerHTML=`
      <div class="date-stamp">${dateStr}</div>
      <div class="rec"><div class="rec-dot"></div>REC</div>
      <h2>ARCHIVE</h2>
      <div class="sub">ANUSHRI TAPE COLLECTION</div>
      <div class="insert-msg">↑ DRAG TAPE TO SLOT ↑</div>
    `;
    el.appendChild(d);
    buildTapeShelf();
  };

  // LOADING
  const loading=async(tapeName)=>{
    clear();
    Noise.burst(500);
    const d=document.createElement('div');d.className='loading-display';
    d.innerHTML=`<div class="load-title">PLAYING: ${tapeName}</div><div class="load-bar"><div class="load-fill" id="load-fill"></div></div>`;
    el.appendChild(d);
    const fill=$('load-fill');
    let w=0;
    await new Promise(r=>{
      const iv=setInterval(()=>{
        w+=Math.random()*6+2;
        fill.style.width=Math.min(w,100)+'%';
        if(w>=100){clearInterval(iv);r()}
      },50);
    });
    await sleep(300);
  };

  // FINAL MESSAGE
  const final=async()=>{
    clear();
    const d=document.createElement('div');d.className='final-display';el.appendChild(d);
    $('screen-glow').style.background='radial-gradient(ellipse,rgba(212,175,55,0.06) 0%,transparent 70%)';
    Synth.stopArp();
    // Warm melody
    const melody=[261.63,329.63,392,523.25,392,329.63,261.63,329.63,392,523.25];
    melody.forEach((f,i)=>setTimeout(()=>Synth.note(f,1.5,'sine',0.04,0.05),i*600));

    const lines=[
      'You played every tape.',
      'You faced the hallway. You fixed the signal.',
      'You looked into the static and found yourself.',
      '',
      'The bravest recording in this archive',
      'was never made by me.',
      '',
      'It was made by <span class="hl">you</span>,',
      'at 2am,',
      'when you told yourself to keep going.',
      '',
      'Happy Birthday, <span class="gold">Anushri</span>.',
      '',
      'I will always be <span class="gold">DADDY</span>.',
    ];
    for(const line of lines){
      const p=document.createElement('p');p.innerHTML=line||'&nbsp;';d.appendChild(p);
      await sleep(80);p.classList.add('show');await sleep(500);
    }
  };

  return{boot,select,loading,final};
})();

/* ═══════════════════════════════════════
   TAPE SHELF & DRAG SYSTEM
   ═══════════════════════════════════════ */
const TAPES=[
  {id:'tape1',title:'SIDE A: The Weight',color:'var(--red)',file:'tape1.html'},
  {id:'tape2',title:'TRACKING: Distortion',color:'var(--blue)',file:'tape2.html'},
  {id:'tape3',title:'PLAY: The Static',color:'var(--cyan)',file:'tape3.html'},
  {id:'tape4',title:'RECORD: For You',color:'var(--gold)',file:'tape4.html',final:true},
];

let dragState=null;

function buildTapeShelf(){
  const shelf=$('tape-shelf');shelf.innerHTML='';
  TAPES.forEach(t=>{
    const done=State.isDone(t.id);
    const locked=t.final&&!State.allDone();
    const tape=document.createElement('div');
    tape.className='vhs-tape'+(done?' complete':'')+(locked?' locked':'');
    tape.dataset.id=t.id;
    tape.dataset.file=t.file;
    tape.dataset.title=t.title;
    tape.innerHTML=`
      <div class="tape-color" style="background:${t.color}"></div>
      <div class="tape-window"><div class="reel"></div><div class="tape-strip"></div><div class="reel"></div></div>
      <div class="tape-label-area">
        <div class="tape-title">${t.title}</div>
        <div class="tape-status">${locked?'LOCKED':done?'✓ PLAYED':'NEW'}</div>
      </div>
    `;
    if(!locked){
      tape.addEventListener('mousedown',e=>startDrag(e,tape,t));
      tape.addEventListener('touchstart',e=>startDrag(e,tape,t),{passive:false});
      tape.addEventListener('click',()=>insertTape(t));
    }
    shelf.appendChild(tape);
  });
}

function startDrag(e,el,tape){
  e.preventDefault();
  const rect=el.getBoundingClientRect();
  const cx=e.clientX||e.touches?.[0]?.clientX||0;
  const cy=e.clientY||e.touches?.[0]?.clientY||0;
  const ghost=el.cloneNode(true);
  ghost.className='vhs-tape tape-ghost';
  ghost.style.width=rect.width+'px';ghost.style.height=rect.height+'px';
  ghost.style.left=rect.left+'px';ghost.style.top=rect.top+'px';
  document.body.appendChild(ghost);
  el.style.opacity='0.25';
  dragState={el,tape,ghost,ox:cx-rect.left,oy:cy-rect.top};
  Synth.selectClick();
}

function moveDrag(e){
  if(!dragState)return;e.preventDefault();
  const cx=e.clientX||e.touches?.[0]?.clientX||0;
  const cy=e.clientY||e.touches?.[0]?.clientY||0;
  dragState.ghost.style.left=(cx-dragState.ox)+'px';
  dragState.ghost.style.top=(cy-dragState.oy)+'px';
  const slotRect=$('tape-slot').getBoundingClientRect();
  const gRect=dragState.ghost.getBoundingClientRect();
  const over=!(gRect.right<slotRect.left||gRect.left>slotRect.right||gRect.bottom<slotRect.top-30||gRect.top>slotRect.bottom+30);
  $('tape-slot').classList.toggle('active',over);
}

function endDrag(e){
  if(!dragState)return;
  const slotRect=$('tape-slot').getBoundingClientRect();
  const gRect=dragState.ghost.getBoundingClientRect();
  const over=!(gRect.right<slotRect.left||gRect.left>slotRect.right||gRect.bottom<slotRect.top-30||gRect.top>slotRect.bottom+30);
  dragState.ghost.remove();
  dragState.el.style.opacity='1';
  $('tape-slot').classList.remove('active');
  if(over)insertTape(dragState.tape);
  dragState=null;
}

document.addEventListener('mousemove',moveDrag);
document.addEventListener('mouseup',endDrag);
document.addEventListener('touchmove',moveDrag,{passive:false});
document.addEventListener('touchend',endDrag);

async function insertTape(tape){
  Synth.init();Synth.resume();
  if(!audioOn){audioOn=true;Synth.setMuted(false);audioBtn.textContent='♪ ON';audioBtn.classList.add('on')}
  Synth.mechClunk();
  Synth.stopArp();
  Noise.burst(600);
  $('slot-label').textContent='▶ LOADING';
  await Screen.loading(tape.title);
  window.location.href=tape.file;
}

/* ═══════════════════════════════════════
   REC TIMER
   ═══════════════════════════════════════ */
let recSec=0;
setInterval(()=>{recSec++},1000);

/* ═══════════════════════════════════════
   INIT
   ═══════════════════════════════════════ */
(async()=>{
  Noise.init();

  // If all tapes done including tape4, show final
  if(State.isDone('tape4')){
    $('led').classList.add('on');
    Synth.init();Synth.resume();Synth.startAmbient();
    if(!audioOn){audioOn=true;Synth.setMuted(false);audioBtn.textContent='♪ ON';audioBtn.classList.add('on')}
    await Screen.final();
    return;
  }

  await Screen.boot();

  // Start audio after user gesture
  Synth.init();Synth.resume();Synth.startAmbient();Synth.startArp();
  if(!audioOn){audioOn=true;Synth.setMuted(false);audioBtn.textContent='♪ ON';audioBtn.classList.add('on')}

  Noise.burst(300);
  await sleep(400);
  Screen.select();
})();
</script>
</body>
</html>
